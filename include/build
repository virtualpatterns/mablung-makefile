
ifndef current-clean-folder
ifndef current-compile-folder

# --------------------
.PHONY: build pre-build lint pre-lint
# --------------------

export exclude-compile-folder += makefile
export exclude-compile-file += .babelrc.json .DS_Store .eslintrc.json makefile

build:: pre-build lint compile
	@:

pre-build:: ;

lint:: pre-lint
	$(info - lint ---------------------------------)
	@npx eslint --cache --cache-location data/cache/eslint.json $(eslint-parameter) source 

pre-lint:: ;

compile:: pre-compile
	$(info - compile ------------------------------)
	$(if $(verbose),@echo create .... release)
	@npx shx mkdir -p release
	$(if $(verbose),@echo build ..... source)
	@$(MAKE) $(if $(job-count),--jobs=$(job-count),--jobs) --no-print-directory build current-compile-folder=source

pre-compile:: ;

else

make-folder = $(strip $\
								$(foreach $\
									item,$\
									$(filter-out $\
										$(exclude-compile-folder),$\
										$(call get-content,$(current-compile-folder))),$\
									$(if $\
										$(call get-content,$(item)),$\
										$(if $\
											$(wildcard $(item)/makefile),$\
											$(item)))))

compile-folder = $(strip $\
									$(foreach $\
										item,$\
										$(filter-out $\
											$(exclude-compile-folder),$\
											$(call get-content,$(current-compile-folder))),$\
										$(if $\
											$(call get-content,$(item)),$\
											$(if $\
												$(wildcard $(item)/makefile),,$\
												$(item)))))

compile-file = $(strip $\
								$(foreach $\
									item,$\
									$(filter-out $\
										$(addprefix $\
											$(current-compile-folder)/,$\
											$(exclude-compile-file)),$\
										$(call get-content,$(current-compile-folder))),$\
									$(patsubst $\
										source/%,$\
										release/%,$\
										$(if $\
											$(call get-content,$(item)),,$\
											$(item)))))

# --------------------
.PHONY: build copy ignore debug
# --------------------

build:: $(addsuffix .make,$(make-folder)) $(addsuffix .compile,$(compile-folder)) $(compile-file)
	@:

source/%.make: release/%.create
	$(if $(verbose),@echo make ...... $(patsubst %.make,%,$@))
	@$(MAKE) --makefile=$(patsubst %.make,%,$@)/makefile --no-print-directory current-compile-folder=$(patsubst %.make,%,$@) current-source-folder=$(patsubst %.make,%,$@) current-release-folder=$(patsubst %.create,%,$<)

source/%.compile: release/%.create
	$(if $(verbose),@echo build ..... $(patsubst %.compile,%,$@))
	@$(MAKE) --no-print-directory build current-compile-folder=$(patsubst %.compile,%,$@)

release/%.create:
	$(if $(verbose),@echo create .... $(patsubst %.create,%,$@))
	@npx shx mkdir -p $(patsubst %.create,%,$@)

release/%.cjs: source/%.cjs
	@echo compile ... $@ $(babel-parameter)
	@npx babel $< --out-file $@ --source-maps true $(babel-parameter)

release/%.js: source/%.js
	@echo compile ... $@ $(babel-parameter)
	@npx babel $< --out-file $@ --source-maps true $(babel-parameter)

release/%: source/%
	@echo copy ...... $@
	@npx shx cp -R $< $(call trim-folder-path,$@)

copy::
	$(if $(verbose),@echo copy ...... $(patsubst source/%,release/%,$(current-compile-folder)))
	@npx shx rm -Rf $(patsubst source/%,release/%,$(current-compile-folder))
	@npx shx cp -R $(current-compile-folder) $(call trim-folder-path,$(patsubst source/%,release/%,$(current-compile-folder)))
	$(if $(verbose),@echo delete .... $(patsubst source/%,release/%,$(current-compile-folder))/makefile)
	@npx shx rm -f $(patsubst source/%,release/%,$(current-compile-folder))/makefile

ignore::
	$(if $(verbose),@echo ignore .... $(current-compile-folder))
	@npx shx rm -Rf $(patsubst source/%,release/%,$(current-compile-folder))

debug::
	$(info - debug --------------------------------)
	$(info current-source-folder .... $(current-source-folder))
	$(info current-release-folder ... $(current-release-folder))
	$(info ----------------------------------------)
	$(info exclude-compile-folder ... $(exclude-compile-folder))
	$(info exclude-compile-file ..... $(exclude-compile-file))
	$(info make-folder .............. $(make-folder))
	$(info compile-folder ........... $(compile-folder))
	$(info compile-file ............. $(compile-file))
	$(info ----------------------------------------)
	@$(MAKE) --no-print-directory build

endif
endif